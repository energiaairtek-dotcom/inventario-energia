<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Consumibles - Energía</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @media print {
            nav, .no-print { display: none !important; }
            main { padding: 0 !important; margin: 0 !important; }
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Firebase SDK Scripts as Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Exponer Firebase al objeto window para acceso global
        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, 
            query, onSnapshot, addDoc, serverTimestamp
        };
        
        // Disparar evento para avisar a React que Firebase está listo
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [sdkReady, setSdkReady] = useState(!!window.FirebaseSDK);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isAdminMode, setIsAdminMode] = useState(false);
            
            const [inventory, setInventory] = useState([]);
            const [history, setHistory] = useState([]);
            const [newExit, setNewExit] = useState({ tech: '', itemId: '', qty: '' });
            const [newItem, setNewItem] = useState({ id: '', name: '', stock: '', min: '', unit: 'pza' });

            // Referencias para Firebase para evitar múltiples inicializaciones
            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appIdRef = useRef('inventario-energia-v1');

            useEffect(() => {
                const handleReady = () => setSdkReady(true);
                window.addEventListener('firebase-ready', handleReady);
                return () => window.removeEventListener('firebase-ready', handleReady);
            }, []);

            // Inicialización de Firebase una vez que el SDK esté disponible
            useEffect(() => {
                if (!sdkReady || !window.FirebaseSDK) return;

                const { initializeApp, getAuth, getFirestore, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = window.FirebaseSDK;

                try {
                    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                    if (!firebaseConfig) {
                        console.error("Firebase config no encontrada");
                        setLoading(false);
                        return;
                    }

                    const app = initializeApp(firebaseConfig);
                    authRef.current = getAuth(app);
                    dbRef.current = getFirestore(app);
                    appIdRef.current = typeof __app_id !== 'undefined' ? __app_id : 'inventario-energia-v1';

                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(authRef.current, __initial_auth_token);
                            } else {
                                await signInAnonymously(authRef.current);
                            }
                        } catch (err) {
                            console.error("Error de autenticación:", err);
                        }
                    };
                    
                    initAuth();
                    const unsubscribe = onAuthStateChanged(authRef.current, (u) => {
                        setUser(u);
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Error inicializando Firebase:", e);
                    setLoading(false);
                }
            }, [sdkReady]);

            // Escucha de datos en tiempo real
            useEffect(() => {
                if (!user || !dbRef.current) return;

                const { collection, onSnapshot } = window.FirebaseSDK;
                const db = dbRef.current;
                const appId = appIdRef.current;

                const invCol = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');
                const histCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');

                const unsubInv = onSnapshot(invCol, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                    setInventory(items);
                }, (error) => console.error("Error inv:", error));

                const unsubHist = onSnapshot(histCol, (snapshot) => {
                    const logs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    const sortedLogs = logs.sort((a, b) => {
                        const timeA = a.timestamp?.seconds || 0;
                        const timeB = b.timestamp?.seconds || 0;
                        return timeB - timeA;
                    });
                    setHistory(sortedLogs);
                }, (error) => console.error("Error hist:", error));

                return () => {
                    unsubInv();
                    unsubHist();
                };
            }, [user]);

            const handleExitSubmit = async (e) => {
                e.preventDefault();
                if (!user || !dbRef.current) return;

                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.FirebaseSDK;
                const item = inventory.find(i => i.id === newExit.itemId);
                
                if (!item || item.stock < Number(newExit.qty)) {
                    alert("Stock insuficiente o material no válido");
                    return;
                }

                try {
                    const itemRef = doc(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'inventory', item.docId);
                    await updateDoc(itemRef, { stock: item.stock - Number(newExit.qty) });
                    
                    await addDoc(collection(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'history'), {
                        tech: newExit.tech,
                        itemId: newExit.itemId,
                        item: item.name,
                        qty: Number(newExit.qty),
                        timestamp: serverTimestamp(),
                        dateStr: new Date().toLocaleString()
                    });
                    
                    setNewExit({ tech: '', itemId: '', qty: '' });
                    setActiveTab('history');
                } catch (err) {
                    console.error("Error salida:", err);
                }
            };

            const addNewItem = async (e) => {
                e.preventDefault();
                if (!user || !dbRef.current) return;
                const { collection, addDoc } = window.FirebaseSDK;
                try {
                    await addDoc(collection(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'inventory'), {
                        ...newItem,
                        id: newItem.id.toUpperCase(),
                        stock: Number(newItem.stock),
                        min: Number(newItem.min)
                    });
                    setNewItem({ id: '', name: '', stock: '', min: '', unit: 'pza' });
                } catch (err) {
                    console.error("Error agregar:", err);
                }
            };

            const deleteItem = async (docId) => {
                if (!user || !dbRef.current) return;
                const { doc, deleteDoc } = window.FirebaseSDK;
                if(confirm("¿Eliminar este material?")) {
                    try {
                        await deleteDoc(doc(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'inventory', docId));
                    } catch (err) {
                        console.error("Error eliminar:", err);
                    }
                }
            };

            const Icon = ({ name, size = 18, className = "" }) => {
                const icons = {
                    Zap: <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" />,
                    LayoutDashboard: <React.Fragment><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></React.Fragment>,
                    Package: <React.Fragment><path d="m7.5 4.27 9 5.15" /><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" /><path d="m3.3 7 8.7 5 8.7-5" /><path d="M12 22V12" /></React.Fragment>,
                    LogOut: <React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></React.Fragment>,
                    History: <React.Fragment><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M12 7v5l4 2" /></React.Fragment>,
                    Settings: <React.Fragment><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.72V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.72V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></React.Fragment>,
                    Printer: <React.Fragment><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect width="12" height="8" x="6" y="14" /></React.Fragment>,
                    Trash2: <React.Fragment><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /></React.Fragment>,
                    Plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></React.Fragment>
                };
                return (
                    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                        {icons[name] || null}
                    </svg>
                );
            };

            if (loading) return (
                <div className="loading-overlay">
                    <div className="flex flex-col items-center gap-4">
                        <div className="animate-spin text-blue-600"><Icon name="Zap" size={48} /></div>
                        <p className="text-[10px] font-black uppercase tracking-widest text-slate-400 italic">Sincronizando Sistema...</p>
                    </div>
                </div>
            );

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center flex-1 transition-all ${activeTab === id ? 'text-blue-600' : 'text-slate-400'}`}>
                    <Icon name={icon} size={24} className={activeTab === id ? 'scale-110' : ''} />
                    <span className="text-[10px] font-bold mt-1 uppercase tracking-tighter">{label}</span>
                </button>
            );

            return (
                <div className="flex flex-col min-h-screen pb-20 md:pb-0 md:pl-64">
                    {/* Navegación Desktop */}
                    <nav className="fixed left-0 top-0 bottom-0 w-64 bg-slate-900 text-white p-6 hidden md:flex flex-col no-print z-50">
                        <div className="flex items-center gap-3 mb-10">
                            <div className="bg-yellow-400 p-2 rounded-lg"><Icon name="Zap" className="text-slate-900" size={24} /></div>
                            <h1 className="font-black text-lg tracking-tight">ENERGÍA <span className="text-blue-500">AIRTEK</span></h1>
                        </div>
                        <div className="space-y-2 flex-1">
                            {['dashboard', 'inventory', 'new-exit', 'history', 'admin'].map((tab) => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-bold transition-all ${activeTab === tab ? 'bg-blue-600 shadow-xl shadow-blue-900/40 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>
                                    <Icon name={tab === 'dashboard' ? 'LayoutDashboard' : tab === 'inventory' ? 'Package' : tab === 'new-exit' ? 'LogOut' : tab === 'history' ? 'History' : 'Settings'} />
                                    {tab.replace('-', ' ').toUpperCase()}
                                </button>
                            ))}
                        </div>
                        <div className="pt-6 border-t border-slate-800">
                            <div className="flex items-center justify-between px-2">
                                <span className="text-[10px] font-black text-slate-500 tracking-widest uppercase">Modo Editor</span>
                                <button onClick={() => setIsAdminMode(!isAdminMode)} className={`w-10 h-5 rounded-full relative transition-colors ${isAdminMode ? 'bg-blue-500' : 'bg-slate-700'}`}>
                                    <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${isAdminMode ? 'left-6' : 'left-1'}`} />
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* Navegación Mobile */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 h-20 flex md:hidden px-2 z-50 no-print">
                        <NavItem id="dashboard" icon="LayoutDashboard" label="Inicio" />
                        <NavItem id="inventory" icon="Package" label="Stock" />
                        <div className="relative -top-6 px-2">
                            <button onClick={() => setActiveTab('new-exit')} className="bg-blue-600 text-white p-5 rounded-3xl shadow-2xl shadow-blue-300 ring-8 ring-slate-50"><Icon name="Plus" size={28} /></button>
                        </div>
                        <NavItem id="history" icon="History" label="Logs" />
                        <NavItem id="admin" icon="Settings" label="Admin" />
                    </nav>

                    <header className="bg-white px-6 py-4 flex justify-between items-center sticky top-0 z-40 md:static border-b border-slate-100 md:border-none">
                        <div className="md:hidden flex items-center gap-2"><Icon name="Zap" className="text-yellow-500" /><span className="font-black text-xs tracking-tighter uppercase italic">Energía</span></div>
                        <h2 className="hidden md:block text-2xl font-black text-slate-800 uppercase tracking-tighter">{activeTab.replace('-', ' ')}</h2>
                        <button onClick={() => window.print()} className="p-2.5 bg-slate-100 text-slate-500 rounded-xl hover:bg-slate-200 no-print transition-all active:scale-90"><Icon name="Printer" size={20} /></button>
                    </header>

                    <main className="p-4 md:p-10 max-w-6xl w-full mx-auto">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-blue-600 to-indigo-800 p-8 rounded-[2rem] text-white shadow-2xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <h3 className="text-3xl font-black leading-none mb-2 tracking-tighter uppercase">ALMACÉN<br/>AIRTEK</h3>
                                        <p className="text-blue-100/80 text-xs font-bold uppercase tracking-widest italic">Datos en la Nube</p>
                                    </div>
                                    <Icon name="Zap" size={120} className="absolute -right-6 -bottom-6 opacity-20 rotate-12" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 text-center">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Stock Crítico</p>
                                        <p className="text-3xl font-black text-red-500 tracking-tighter">{inventory.filter(i=>i.stock <= i.min).length}</p>
                                    </div>
                                    <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 text-center">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Registros</p>
                                        <p className="text-3xl font-black text-blue-900 tracking-tighter">{history.length}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'inventory' && (
                            <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                                <table className="w-full text-left">
                                    <thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400 border-b">
                                        <tr><th className="px-6 py-4">Insumo</th><th className="px-6 py-4">Stock</th><th className="px-6 py-4">Status</th>{isAdminMode && <th className="px-6 py-4">Acción</th>}</tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {inventory.map(item => (
                                            <tr key={item.docId}>
                                                <td className="px-6 py-4 font-bold text-xs uppercase">{item.name}</td>
                                                <td className="px-6 py-4 font-black">{item.stock} <span className="text-[9px] text-slate-400">{item.unit}</span></td>
                                                <td className="px-6 py-4">
                                                    {item.stock <= item.min ? <span className="text-red-500 font-black text-[9px] uppercase">Bajo</span> : <span className="text-emerald-500 font-black text-[9px] uppercase">Ok</span>}
                                                </td>
                                                {isAdminMode && <td className="px-6 py-4"><button onClick={()=>deleteItem(item.docId)} className="text-slate-300 hover:text-red-500"><Icon name="Trash2" size={16}/></button></td>}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {activeTab === 'new-exit' && (
                            <div className="max-w-md mx-auto bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
                                <h3 className="text-xl font-black uppercase mb-6 italic underline decoration-blue-500 underline-offset-4">Nueva Salida</h3>
                                <form onSubmit={handleExitSubmit} className="space-y-4">
                                    <input required placeholder="Técnico" className="w-full p-4 bg-slate-50 rounded-2xl text-xs" value={newExit.tech} onChange={e=>setNewExit({...newExit, tech: e.target.value})} />
                                    <select required className="w-full p-4 bg-slate-50 rounded-2xl text-xs" value={newExit.itemId} onChange={e=>setNewExit({...newExit, itemId: e.target.value})}>
                                        <option value="">Seleccionar Material</option>
                                        {inventory.map(i => <option key={i.docId} value={i.id}>{i.name} ({i.stock})</option>)}
                                    </select>
                                    <input required type="number" placeholder="Cantidad" className="w-full p-4 bg-slate-50 rounded-2xl text-xs" value={newExit.qty} onChange={e=>setNewExit({...newExit, qty: e.target.value})} />
                                    <button className="w-full bg-blue-600 text-white p-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg active:scale-95 transition-all">Confirmar Salida</button>
                                </form>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-3">
                                {history.map(h => (
                                    <div key={h.id} className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center">
                                        <div>
                                            <h4 className="font-black text-[11px] uppercase">{h.item}</h4>
                                            <p className="text-[10px] text-slate-400">Técnico: {h.tech}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-[11px] font-black text-blue-600">-{h.qty}</p>
                                            <p className="text-[9px] text-slate-300 font-mono">{h.dateStr}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'admin' && (
                            <div className="max-w-md mx-auto">
                                {isAdminMode ? (
                                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                                        <h3 className="text-xl font-black uppercase mb-6 italic">Nuevo Insumo</h3>
                                        <form onSubmit={addNewItem} className="space-y-4">
                                            <input required placeholder="ID / SKU" className="w-full p-4 bg-slate-50 rounded-2xl text-xs uppercase" value={newItem.id} onChange={e=>setNewItem({...newItem, id: e.target.value.toUpperCase()})} />
                                            <input required placeholder="Nombre" className="w-full p-4 bg-slate-50 rounded-2xl text-xs" value={newItem.name} onChange={e=>setNewItem({...newItem, name: e.target.value})} />
                                            <div className="grid grid-cols-2 gap-4">
                                                <input required type="number" placeholder="Stock" className="p-4 bg-slate-50 rounded-2xl text-xs" value={newItem.stock} onChange={e=>setNewItem({...newItem, stock: e.target.value})} />
                                                <input required type="number" placeholder="Min" className="p-4 bg-slate-50 rounded-2xl text-xs" value={newItem.min} onChange={e=>setNewItem({...newItem, min: e.target.value})} />
                                            </div>
                                            <button className="w-full bg-slate-900 text-white p-4 rounded-2xl font-black text-[10px] uppercase tracking-widest">Agregar al Maestro</button>
                                        </form>
                                    </div>
                                ) : (
                                    <div className="p-10 text-center opacity-40 uppercase font-black text-[10px] tracking-widest italic">Activa el Modo Editor para gestionar el catálogo</div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
