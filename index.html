<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airtek - Gestión de Consumibles Energía</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            letter-spacing: -0.01em;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .bg-airtek {
            background: linear-gradient(135deg, #0052D4 0%, #4364F7 50%, #6FB1FC 100%);
        }
        
        .shadow-premium {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }

        .tab-content {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilo para los inputs */
        input:focus, select:focus {
            box-shadow: 0 0 0 4px rgba(67, 100, 247, 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const myConfig = {
            apiKey: "AIzaSyDwaK4Z26RfqDwNvwdMqri08oEjwG9qymc",
            authDomain: "almacen-airtek.firebaseapp.com",
            projectId: "almacen-airtek",
            storageBucket: "almacen-airtek.firebasestorage.app",
            messagingSenderId: "934058211778",
            appId: "1:934058211778:web:6cc9d820c41fa90aa5fe5b"
        };

        window.__firebase_config_manual = JSON.stringify(myConfig);

        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, 
            query, onSnapshot, addDoc, serverTimestamp
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isCloud, setIsCloud] = useState(false);
            const [inventory, setInventory] = useState([]);
            const [history, setHistory] = useState([]);
            const [activeTab, setActiveTab] = useState('inventory');
            const [newExit, setNewExit] = useState({ tech: '', itemId: '', qty: '', description: '' });
            const [newItem, setNewItem] = useState({ id: '', name: '', stock: '', min: 5, unit: 'pza' });

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'airtek-energia-v1';

            // Usando el logo proporcionado
            const airtekLogo = "image_5ab619.jpg";

            useEffect(() => {
                const init = async () => {
                    if (!window.FirebaseSDK) return;
                    const { initializeApp, getAuth, getFirestore, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.FirebaseSDK;
                    
                    try {
                        const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : window.__firebase_config_manual;
                        const config = JSON.parse(configStr);

                        const app = initializeApp(config);
                        dbRef.current = getFirestore(app);
                        authRef.current = getAuth(app);

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(authRef.current, __initial_auth_token);
                        } else {
                            await signInAnonymously(authRef.current);
                        }

                        const unsubscribe = onAuthStateChanged(authRef.current, (u) => {
                            if (u) {
                                setUser(u);
                                setIsCloud(true);
                            }
                            setLoading(false);
                        });
                        return unsubscribe;
                    } catch (e) {
                        console.error(e);
                        setLoading(false);
                    }
                };

                window.addEventListener('firebase-ready', init);
                if (window.FirebaseSDK) init();
                return () => window.removeEventListener('firebase-ready', init);
            }, []);

            useEffect(() => {
                if (!isCloud || !user || !dbRef.current) return;
                const { collection, onSnapshot } = window.FirebaseSDK;

                const invPath = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory');
                const histPath = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history');

                const unsubInv = onSnapshot(invPath, (snap) => {
                    setInventory(snap.docs.map(d => ({ ...d.data(), docId: d.id })));
                });

                const unsubHist = onSnapshot(histPath, (snap) => {
                    const logs = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                    setHistory(logs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
                });

                return () => { unsubInv(); unsubHist(); };
            }, [isCloud, user, appId]);

            const updateStock = async (docId, currentStock, mod) => {
                const { doc, updateDoc } = window.FirebaseSDK;
                try {
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory', docId), {
                        stock: Math.max(0, currentStock + mod)
                    });
                } catch (err) { alert("Error al actualizar"); }
            };

            const handleExit = async (e) => {
                e.preventDefault();
                const item = inventory.find(i => i.id === newExit.itemId);
                if (!item || item.stock < Number(newExit.qty)) return alert("Stock insuficiente");

                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.FirebaseSDK;
                try {
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory', item.docId), {
                        stock: item.stock - Number(newExit.qty)
                    });

                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history'), {
                        tech: newExit.tech,
                        item: item.name,
                        itemId: item.id,
                        qty: Number(newExit.qty),
                        description: newExit.description,
                        dateStr: new Date().toLocaleString(),
                        timestamp: serverTimestamp()
                    });

                    setNewExit({ tech: '', itemId: '', qty: '', description: '' });
                    setActiveTab('history');
                } catch (err) { alert("Error al registrar"); }
            };

            const handleAddItem = async (e) => {
                e.preventDefault();
                const { collection, addDoc, serverTimestamp } = window.FirebaseSDK;
                try {
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory'), {
                        ...newItem,
                        stock: Number(newItem.stock),
                        min: Number(newItem.min),
                        createdAt: serverTimestamp()
                    });
                    setNewItem({ id: '', name: '', stock: '', min: 5, unit: 'pza' });
                    setActiveTab('inventory');
                } catch (err) { alert("Error al agregar"); }
            };

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-white">
                    <img src={airtekLogo} className="w-48 mb-6 animate-pulse" alt="Airtek" />
                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Iniciando Sistema de Energía...</p>
                </div>
            );

            return (
                <div className="min-h-screen pb-20">
                    {/* Header Principal */}
                    <header className="bg-white border-b border-slate-100 sticky top-0 z-50 px-6 py-5">
                        <div className="max-w-3xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <img src={airtekLogo} className="h-10 w-auto object-contain" alt="Airtek Logo" />
                                <div className="h-8 w-px bg-slate-200 hidden md:block"></div>
                                <div>
                                    <h1 className="text-sm font-black text-slate-800 uppercase tracking-tight leading-none">Gestión de Insumos</h1>
                                    <p className="text-[9px] font-bold text-slate-400 uppercase tracking-[0.15em] mt-1">Op. y Mantenimiento de Energía</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 self-start md:self-auto bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                                <span className="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                                <span className="text-[9px] font-extrabold text-slate-500 uppercase tracking-wider">Cloud Live</span>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-3xl mx-auto p-4 space-y-6 mt-4">
                        {/* Navegación Principal */}
                        <nav className="flex gap-1.5 bg-white p-1.5 rounded-3xl shadow-premium border border-slate-100 overflow-x-auto no-scrollbar">
                            {[
                                {id: 'inventory', label: 'Stock Actual'}, 
                                {id: 'exit', label: 'Registrar Uso'}, 
                                {id: 'admin', label: 'Administrar'}, 
                                {id: 'history', label: 'Bitácora'}
                            ].map(t => (
                                <button 
                                    key={t.id} 
                                    onClick={() => setActiveTab(t.id)} 
                                    className={`flex-1 min-w-[100px] py-3.5 rounded-2xl font-bold text-[10px] uppercase tracking-wider transition-all ${activeTab === t.id ? 'bg-airtek text-white shadow-lg' : 'text-slate-400 hover:text-slate-600'}`}
                                >
                                    {t.label}
                                </button>
                            ))}
                        </nav>

                        <main className="tab-content">
                            {/* VISTA DE INVENTARIO */}
                            {activeTab === 'inventory' && (
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-4">
                                        <h2 className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Inventario de Consumibles</h2>
                                        <span className="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full border border-blue-100">{inventory.length} Ítems</span>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {inventory.map(i => (
                                            <div key={i.docId} className="bg-white p-5 rounded-[2rem] flex flex-col sm:flex-row justify-between items-center shadow-sm border border-slate-100 hover:border-blue-200 transition-all gap-4">
                                                <div className="flex flex-col text-center sm:text-left">
                                                    <span className="font-extrabold text-[13px] uppercase tracking-tight text-slate-800">{i.name}</span>
                                                    <div className="flex items-center justify-center sm:justify-start gap-2 mt-1">
                                                        <span className="text-[9px] text-slate-400 font-mono font-bold">{i.id}</span>
                                                        {i.stock <= i.min && <span className="text-[8px] font-black text-white bg-red-500 px-2 py-0.5 rounded-full uppercase">Crítico</span>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4 bg-slate-50 p-1.5 rounded-2xl border border-slate-100">
                                                    <button onClick={() => updateStock(i.docId, i.stock, -1)} className="w-9 h-9 flex items-center justify-center bg-white rounded-xl shadow-sm font-bold text-slate-400 hover:text-red-500 transition-colors">-</button>
                                                    <div className="px-4 text-center min-w-[60px]">
                                                        <div className={`font-black text-base leading-none ${i.stock <= i.min ? 'text-red-500' : 'text-slate-900'}`}>{i.stock}</div>
                                                        <div className="text-[8px] text-slate-300 font-extrabold uppercase mt-1">{i.unit}</div>
                                                    </div>
                                                    <button onClick={() => updateStock(i.docId, i.stock, 1)} className="w-9 h-9 flex items-center justify-center bg-white rounded-xl shadow-sm font-bold text-slate-400 hover:text-emerald-500 transition-colors">+</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    {inventory.length === 0 && <div className="text-center py-20 text-slate-300 font-bold text-xs uppercase tracking-widest italic">No hay insumos registrados</div>}
                                </div>
                            )}

                            {/* REGISTRO DE SALIDA */}
                            {activeTab === 'exit' && (
                                <form onSubmit={handleExit} className="bg-white p-8 rounded-[2.5rem] shadow-premium border border-slate-100 space-y-5">
                                    <div className="text-center space-y-1 mb-4">
                                        <h3 className="text-sm font-black uppercase text-slate-800 tracking-tight">Reporte de Consumo</h3>
                                        <p className="text-[9px] font-bold text-slate-400 uppercase tracking-[0.2em] italic">Asignación técnica de energía</p>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Nombre del Técnico</label>
                                        <input required placeholder="EJ: JUAN PÉREZ" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none uppercase transition-all" value={newExit.tech} onChange={e=>setNewExit({...newExit, tech: e.target.value})} />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Material a Retirar</label>
                                        <select required className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none appearance-none transition-all" value={newExit.itemId} onChange={e=>setNewExit({...newExit, itemId: e.target.value})}>
                                            <option value="">SELECCIONAR DEL STOCK...</option>
                                            {inventory.map(i => <option key={i.docId} value={i.id}>{i.name.toUpperCase()} ({i.stock} DISP.)</option>)}
                                        </select>
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex-1 space-y-1">
                                            <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Cantidad</label>
                                            <input required type="number" placeholder="00" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none text-center" value={newExit.qty} onChange={e=>setNewExit({...newExit, qty: e.target.value})} />
                                        </div>
                                        <div className="flex-[2] space-y-1">
                                            <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Actividad / Proyecto</label>
                                            <input required placeholder="MANTENIMIENTO TABLERO A" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none uppercase" value={newExit.description} onChange={e=>setNewExit({...newExit, description: e.target.value})} />
                                        </div>
                                    </div>
                                    <button className="w-full bg-airtek text-white p-5 rounded-2xl font-black uppercase text-[11px] tracking-[0.2em] shadow-xl hover:opacity-95 active:scale-95 transition-all mt-4">Confirmar y Actualizar Stock</button>
                                </form>
                            )}

                            {/* ADMINISTRACIÓN (ALTAS) */}
                            {activeTab === 'admin' && (
                                <form onSubmit={handleAddItem} className="bg-white p-8 rounded-[2.5rem] shadow-premium border border-slate-100 space-y-5">
                                    <div className="text-center space-y-1 mb-4">
                                        <h3 className="text-sm font-black uppercase text-slate-800 tracking-tight">Nuevo Insumo Maestro</h3>
                                        <p className="text-[9px] font-bold text-blue-500 uppercase tracking-[0.2em] italic">Coordinación de Energía</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Código SKU</label>
                                            <input required placeholder="SKU-001" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none uppercase" value={newItem.id} onChange={e=>setNewItem({...newItem, id: e.target.value.toUpperCase()})} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Nombre Comercial</label>
                                            <input required placeholder="CONECTOR OJO 6MM" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none uppercase" value={newItem.name} onChange={e=>setNewItem({...newItem, name: e.target.value})} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Stock Inicial</label>
                                            <input required type="number" placeholder="00" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none" value={newItem.stock} onChange={e=>setNewItem({...newItem, stock: e.target.value})} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[9px] font-black text-slate-400 uppercase ml-4">Unidad (PZA, ROLL...)</label>
                                            <input required placeholder="PZA" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold border-2 border-transparent focus:border-blue-400 outline-none uppercase text-center" value={newItem.unit} onChange={e=>setNewItem({...newItem, unit: e.target.value})} />
                                        </div>
                                    </div>
                                    <button className="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase text-[11px] tracking-[0.2em] shadow-lg hover:bg-slate-800 active:scale-95 transition-all">Registrar en el Sistema</button>
                                </form>
                            )}

                            {/* BITÁCORA / HISTORIAL */}
                            {activeTab === 'history' && (
                                <div className="space-y-3">
                                    <h2 className="text-[10px] font-black uppercase text-slate-400 tracking-widest px-4">Movimientos Recientes</h2>
                                    {history.map(h => (
                                        <div key={h.id} className="bg-white p-5 rounded-[2.2rem] flex flex-col sm:flex-row justify-between items-center shadow-sm border border-slate-100 border-l-4 border-l-blue-500 gap-3">
                                            <div className="flex flex-col text-center sm:text-left">
                                                <div className="font-extrabold text-[12px] uppercase text-slate-800 leading-tight">{h.item}</div>
                                                <div className="text-[9px] font-bold text-slate-400 mt-0.5 uppercase tracking-wide">
                                                    Técnico: <span className="text-blue-600">{h.tech}</span> • {h.description}
                                                </div>
                                            </div>
                                            <div className="text-center sm:text-right shrink-0">
                                                <div className="text-red-500 font-black text-sm italic leading-none">-{h.qty}</div>
                                                <div className="text-[8px] text-slate-300 font-bold uppercase mt-1.5">{h.dateStr}</div>
                                            </div>
                                        </div>
                                    ))}
                                    {history.length === 0 && <div className="py-20 text-center text-slate-300 font-bold italic text-xs uppercase tracking-widest">Sin registros de uso</div>}
                                </div>
                            )}
                        </main>
                    </div>
                    
                    {/* Footer Corporativo */}
                    <footer className="mt-12 py-10 text-center border-t border-slate-100 px-6">
                        <img src={airtekLogo} className="h-6 object-contain mx-auto opacity-20 grayscale mb-3" alt="Airtek Logo" />
                        <div className="max-w-md mx-auto space-y-1">
                            <p className="text-[9px] font-black text-slate-300 uppercase tracking-[0.25em]">Coordinación de Operaciones y Mantenimiento de Energía</p>
                            <p className="text-[8px] font-bold text-slate-400 uppercase tracking-widest italic">Sistema de Gestión de Consumibles • 2025</p>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
