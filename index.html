<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airtek Cloud Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN: Pega aquí los datos que copiaste de tu consola de Firebase
        const myConfig = {
              apiKey: "AIzaSyDwaK4Z26RfqDwNvwdMqri08oEjwG9qymc",
  authDomain: "almacen-airtek.firebaseapp.com",
  projectId: "almacen-airtek",
  storageBucket: "almacen-airtek.firebasestorage.app",
  messagingSenderId: "934058211778",
  appId: "1:934058211778:web:6cc9d820c41fa90aa5fe5b"
        };

        window.__firebase_config_manual = JSON.stringify(myConfig);

        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, 
            query, onSnapshot, addDoc, serverTimestamp
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isCloud, setIsCloud] = useState(false);
            const [inventory, setInventory] = useState([]);
            const [history, setHistory] = useState([]);
            const [activeTab, setActiveTab] = useState('inventory');
            const [newExit, setNewExit] = useState({ tech: '', itemId: '', qty: '' });
            const [errorMsg, setErrorMsg] = useState(null);

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'airtek-app-v1';

            useEffect(() => {
                const init = async () => {
                    if (!window.FirebaseSDK) return;
                    const { initializeApp, getAuth, getFirestore, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.FirebaseSDK;
                    
                    try {
                        const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : window.__firebase_config_manual;
                        const config = JSON.parse(configStr);

                        if (!config.apiKey) {
                            setIsCloud(false);
                            setLoading(false);
                            return;
                        }

                        const app = initializeApp(config);
                        dbRef.current = getFirestore(app);
                        authRef.current = getAuth(app);

                        // Regla de Oro: Autenticar siempre antes de consultar
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(authRef.current, __initial_auth_token);
                        } else {
                            await signInAnonymously(authRef.current);
                        }

                        const unsubscribe = onAuthStateChanged(authRef.current, (u) => {
                            if (u) {
                                setUser(u);
                                setIsCloud(true);
                            }
                            setLoading(false);
                        });
                        return unsubscribe;
                    } catch (e) {
                        console.error("Firebase Auth Error:", e);
                        setErrorMsg("Error de autenticación. Revisa la configuración de Firebase.");
                        setIsCloud(false);
                        setLoading(false);
                    }
                };

                window.addEventListener('firebase-ready', init);
                if (window.FirebaseSDK) init();
                return () => window.removeEventListener('firebase-ready', init);
            }, []);

            // Lectura de datos protegida por estado de usuario
            useEffect(() => {
                if (!isCloud || !user || !dbRef.current) return;
                const { collection, onSnapshot } = window.FirebaseSDK;

                // Importante: Usar la ruta obligatoria para evitar Permission Denied
                const invPath = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory');
                const histPath = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history');

                const unsubInv = onSnapshot(invPath, 
                    (snap) => {
                        setInventory(snap.docs.map(d => ({ ...d.data(), docId: d.id })));
                        setErrorMsg(null);
                    },
                    (err) => {
                        console.error("Inventory Error:", err);
                        if (err.code === 'permission-denied') {
                            setErrorMsg("Permisos insuficientes. Configura las Reglas de Firestore en 'Modo de prueba'.");
                        }
                    }
                );

                const unsubHist = onSnapshot(histPath, 
                    (snap) => {
                        const logs = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                        setHistory(logs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
                    },
                    (err) => console.error("History Error:", err)
                );

                return () => { unsubInv(); unsubHist(); };
            }, [isCloud, user, appId]);

            const handleExit = async (e) => {
                e.preventDefault();
                if (!user) return;
                
                const item = inventory.find(i => i.id === newExit.itemId);
                if (!item || item.stock < Number(newExit.qty)) return alert("Stock insuficiente o item no encontrado");

                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.FirebaseSDK;

                try {
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory', item.docId), {
                        stock: item.stock - Number(newExit.qty)
                    });

                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history'), {
                        tech: newExit.tech,
                        item: item.name,
                        itemId: item.id,
                        qty: Number(newExit.qty),
                        dateStr: new Date().toLocaleString(),
                        timestamp: serverTimestamp()
                    });

                    setNewExit({ tech: '', itemId: '', qty: '' });
                    setActiveTab('history');
                } catch (err) {
                    console.error("Update Error:", err);
                    alert("Error al guardar: Permisos denegados.");
                }
            };

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-50">
                    <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="font-black text-xs text-slate-400 tracking-widest uppercase italic">Iniciando Sistema...</p>
                </div>
            );

            return (
                <div className="p-4 max-w-2xl mx-auto space-y-6 pb-10">
                    <header className="flex justify-between items-center bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100">
                        <div>
                            <h1 className="font-black italic text-blue-600 text-xl tracking-tighter leading-none">AIRTEK</h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Energía & Control</p>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                            <span className={`text-[9px] px-2 py-0.5 rounded-full font-black uppercase tracking-tighter ${isCloud ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`}>
                                {isCloud ? 'Cloud Sync' : 'Local Only'}
                            </span>
                            {user && <span className="text-[8px] text-slate-300 font-mono">ID: {user.uid.substring(0,8)}...</span>}
                        </div>
                    </header>

                    {errorMsg && (
                        <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-xl">
                            <p className="text-[10px] font-bold text-red-700 uppercase mb-1">Error de Sistema:</p>
                            <p className="text-xs text-red-600 leading-tight">{errorMsg}</p>
                        </div>
                    )}

                    {!isCloud && !errorMsg && (
                        <div className="bg-amber-50 border border-amber-200 p-4 rounded-2xl">
                            <p className="text-[10px] font-black text-amber-600 uppercase mb-1 italic">Atención:</p>
                            <p className="text-xs text-amber-700 leading-tight">Configura tu <strong>apiKey</strong> en el código para habilitar la nube.</p>
                        </div>
                    )}

                    <nav className="flex gap-2 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100">
                        {['inventory', 'exit', 'history'].map(t => (
                            <button 
                                key={t} 
                                onClick={() => setActiveTab(t)} 
                                className={`flex-1 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all ${activeTab === t ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'text-slate-400 hover:bg-slate-50'}`}
                            >
                                {t === 'exit' ? 'Salidas' : t === 'history' ? 'Logs' : 'Stock'}
                            </button>
                        ))}
                    </nav>

                    <main>
                        {activeTab === 'inventory' && (
                            <div className="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-slate-100">
                                <div className="p-4 bg-slate-50 border-b border-slate-100 flex justify-between">
                                    <span className="text-[10px] font-black text-slate-400 uppercase">Insumo</span>
                                    <span className="text-[10px] font-black text-slate-400 uppercase">Cantidad</span>
                                </div>
                                <div className="divide-y divide-slate-50">
                                    {inventory.map(i => (
                                        <div key={i.docId} className="p-5 flex justify-between items-center hover:bg-slate-50/50 transition-colors">
                                            <div className="flex flex-col">
                                                <span className="font-bold text-sm uppercase tracking-tight text-slate-700">{i.name}</span>
                                                <span className="text-[9px] text-slate-400 font-mono tracking-widest">{i.id}</span>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className={`font-black text-lg ${i.stock <= (i.min || 5) ? 'text-red-500' : 'text-blue-600'}`}>{i.stock}</span>
                                                <span className="text-[10px] text-slate-300 font-bold uppercase">{i.unit || 'pza'}</span>
                                            </div>
                                        </div>
                                    ))}
                                    {inventory.length === 0 && (
                                        <div className="p-16 text-center">
                                            <p className="text-slate-300 italic text-xs mb-1 tracking-tighter">Esperando datos de la nube...</p>
                                            <p className="text-[9px] text-slate-200 uppercase font-bold tracking-widest leading-none">Verifica las reglas de Firestore</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'exit' && (
                            <form onSubmit={handleExit} className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-5">
                                <h3 className="text-center text-xs font-black uppercase tracking-[0.2em] text-slate-400 mb-2 italic">Nueva Transacción</h3>
                                <div className="space-y-1">
                                    <label className="text-[9px] font-black text-slate-400 uppercase ml-3 tracking-widest">Técnico Responsable</label>
                                    <input required placeholder="Ej: Juan Perez" className="w-full p-4 bg-slate-50 rounded-2xl text-sm border-2 border-transparent focus:border-blue-500 outline-none transition-all" value={newExit.tech} onChange={e=>setNewExit({...newExit, tech: e.target.value})} />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[9px] font-black text-slate-400 uppercase ml-3 tracking-widest">Insumo a retirar</label>
                                    <select required className="w-full p-4 bg-slate-50 rounded-2xl text-sm border-2 border-transparent focus:border-blue-500 outline-none transition-all appearance-none" value={newExit.itemId} onChange={e=>setNewExit({...newExit, itemId: e.target.value})}>
                                        <option value="">Selecciona un item...</option>
                                        {inventory.map(i => <option key={i.docId} value={i.id}>{i.name} (Disponible: {i.stock})</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[9px] font-black text-slate-400 uppercase ml-3 tracking-widest">Cantidad</label>
                                    <input required type="number" placeholder="0" className="w-full p-4 bg-slate-50 rounded-2xl text-sm border-2 border-transparent focus:border-blue-500 outline-none transition-all" value={newExit.qty} onChange={e=>setNewExit({...newExit, qty: e.target.value})} />
                                </div>
                                <button disabled={!isCloud} className="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase text-[10px] tracking-[0.3em] shadow-xl active:scale-95 disabled:opacity-30 transition-all">
                                    Procesar Salida
                                </button>
                            </form>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-3">
                                {history.map(h => (
                                    <div key={h.id} className="bg-white p-5 rounded-3xl flex justify-between items-center shadow-sm border border-slate-100">
                                        <div className="flex flex-col gap-1">
                                            <div className="font-black text-[11px] uppercase tracking-tight text-slate-800 leading-none">{h.item}</div>
                                            <div className="text-[10px] font-bold text-slate-400 italic">Por: {h.tech}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-blue-600 font-black text-sm tracking-tighter">-{h.qty}</div>
                                            <div className="text-[8px] text-slate-300 font-mono uppercase">{h.dateStr}</div>
                                        </div>
                                    </div>
                                ))}
                                {history.length === 0 && (
                                    <div className="p-10 text-center text-slate-300 italic text-xs">Sin movimientos registrados.</div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


