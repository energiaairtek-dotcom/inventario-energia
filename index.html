<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airtek - Gestión de Consumibles Energía</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            letter-spacing: -0.01em;
            text-transform: uppercase;
        }
        
        .shadow-premium {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }

        .tab-content {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .pulse-online {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .4; }
        }

        input, select, textarea, option {
            text-transform: uppercase !important;
        }

        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, onSnapshot, addDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const myConfig = {
            apiKey: "AIzaSyDwaK4Z26RfqDwNvwdMqri08oEjwG9qymc",
            authDomain: "almacen-airtek.firebaseapp.com",
            projectId: "almacen-airtek",
            storageBucket: "almacen-airtek.firebasestorage.app",
            messagingSenderId: "934058211778",
            appId: "1:934058211778:web:6cc9d820c41fa90aa5fe5b"
        };

        window.__firebase_config_manual = JSON.stringify(myConfig);

        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, 
            query, onSnapshot, addDoc, serverTimestamp, writeBatch
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const EnergyLogo = ({ className = "h-8 w-8" }) => (
            <svg viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isCloud, setIsCloud] = useState(false);
            const [inventory, setInventory] = useState([]);
            const [history, setHistory] = useState([]);
            const [tools, setTools] = useState([]);
            const [activeTab, setActiveTab] = useState('inventory');
            const [exitHeader, setExitHeader] = useState({ tech: '', monitor: '', description: '' });
            const [currentSearch, setCurrentSearch] = useState('');
            const [toolSearch, setToolSearch] = useState(''); // Nueva búsqueda de herramientas
            const [showSearchList, setShowSearchList] = useState(false);
            const [selectedItems, setSelectedItems] = useState([]); 
            const [loaningTool, setLoaningTool] = useState(null);
            const [loanData, setLoanData] = useState({ tech: '', monitor: '' });
            const [newTool, setNewTool] = useState({ id: '', name: '', brand: '', serial: '' });
            const [filterItemId, setFilterItemId] = useState('all');
            const [newItem, setNewItem] = useState({ id: '', name: '', stock: '', min: 5, unit: 'PZA' });
            const [editingItem, setEditingItem] = useState(null);
            const [restockItem, setRestockItem] = useState(null);
            const [restockQty, setRestockQty] = useState('');
            const [restockResp, setRestockResp] = useState('');
            const [isAdminMode, setIsAdminMode] = useState(false);

            const dbRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'airtek-energia-v1';
            const monitoresAlmacen = ["LUIS RAMOS", "GUSTAVO RINCÓN", "DIEGO CHACÍN"];

            useEffect(() => {
                const init = async () => {
                    if (!window.FirebaseSDK) return;
                    const { initializeApp, getAuth, getFirestore, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.FirebaseSDK;
                    try {
                        const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : window.__firebase_config_manual;
                        const config = JSON.parse(configStr);
                        const app = initializeApp(config);
                        dbRef.current = getFirestore(app);
                        const auth = getAuth(app);
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        const unsubscribe = onAuthStateChanged(auth, (u) => {
                            if (u) { setUser(u); setIsCloud(true); }
                            setLoading(false);
                        });
                        return unsubscribe;
                    } catch (e) { setLoading(false); }
                };
                window.addEventListener('firebase-ready', init);
                if (window.FirebaseSDK) init();
                return () => window.removeEventListener('firebase-ready', init);
            }, []);

            useEffect(() => {
                if (!isCloud || !user || !dbRef.current) return;
                const { collection, onSnapshot } = window.FirebaseSDK;
                const invPath = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory');
                const histPath = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history');
                const toolsPath = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'tools_inventory');
                const unsubInv = onSnapshot(invPath, (snap) => setInventory(snap.docs.map(d => ({ ...d.data(), docId: d.id }))));
                const unsubHist = onSnapshot(histPath, (snap) => setHistory(snap.docs.map(d => ({ ...d.data(), id: d.id })).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))));
                const unsubTools = onSnapshot(toolsPath, (snap) => setTools(snap.docs.map(d => ({ ...d.data(), docId: d.id }))));
                return () => { unsubInv(); unsubHist(); unsubTools(); };
            }, [isCloud, user, appId]);

            // Herramientas ordenadas y filtradas
            const sortedAndFilteredTools = useMemo(() => {
                let list = [...tools];
                // Orden alfabético
                list.sort((a, b) => a.name.localeCompare(b.name));
                // Filtro de búsqueda
                if (toolSearch) {
                    const search = toolSearch.toLowerCase();
                    list = list.filter(t => t.name.toLowerCase().includes(search) || t.id.toLowerCase().includes(search));
                }
                return list;
            }, [tools, toolSearch]);

            const handleToolLoan = async (e) => {
                e.preventDefault();
                if (!loaningTool) return;
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.FirebaseSDK;
                const dateStr = new Date().toLocaleString().toUpperCase();
                try {
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'tools_inventory', loaningTool.docId), {
                        status: 'PRESTADO',
                        assignedTo: loanData.tech.toUpperCase(),
                        lastMove: dateStr
                    });
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history'), {
                        type: 'PRESTAMO_HERRAMIENTA',
                        item: loaningTool.name.toUpperCase(),
                        itemId: loaningTool.id.toUpperCase(),
                        qty: 1,
                        tech: loanData.tech.toUpperCase(),
                        monitor: loanData.monitor.toUpperCase(),
                        dateStr: dateStr,
                        timestamp: serverTimestamp()
                    });
                    setLoaningTool(null); setLoanData({ tech: '', monitor: '' });
                } catch (err) { console.error(err); }
            };

            const handleToolReturn = async (tool) => {
                if(!confirm(`¿CONFIRMAS LA DEVOLUCIÓN DE: ${tool.name}?`)) return;
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.FirebaseSDK;
                const dateStr = new Date().toLocaleString().toUpperCase();
                try {
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'tools_inventory', tool.docId), {
                        status: 'DISPONIBLE',
                        assignedTo: null,
                        lastMove: dateStr
                    });
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history'), {
                        type: 'DEVOLUCION_HERRAMIENTA',
                        item: tool.name.toUpperCase(),
                        itemId: tool.id.toUpperCase(),
                        qty: 1,
                        tech: tool.assignedTo || 'DESCONOCIDO',
                        monitor: 'ALMACÉN',
                        dateStr: dateStr,
                        timestamp: serverTimestamp()
                    });
                } catch (err) { console.error(err); }
            };

            const handleAddTool = async (e) => {
                e.preventDefault();
                const { collection, addDoc, serverTimestamp } = window.FirebaseSDK;
                try {
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'tools_inventory'), {
                        id: newTool.id.toUpperCase(),
                        name: newTool.name.toUpperCase(),
                        brand: newTool.brand.toUpperCase(),
                        serial: newTool.serial.toUpperCase(),
                        status: 'DISPONIBLE',
                        createdAt: serverTimestamp()
                    });
                    setNewTool({ id: '', name: '', brand: '', serial: '' });
                } catch (err) { console.error(err); }
            };

            const deleteTool = async (docId, name) => {
                if(!confirm(`¿ELIMINAR HERRAMIENTA: ${name}?`)) return;
                const { doc, deleteDoc } = window.FirebaseSDK;
                try { await deleteDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'tools_inventory', docId)); } catch (err) { console.error(err); }
            };

            const exportInventoryPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18);
                doc.text("AIRTEK ENERGÍA - REPORTE DE INVENTARIO", 14, 20);
                doc.setFontSize(10);
                doc.text(`GENERADO: ${new Date().toLocaleString().toUpperCase()}`, 14, 28);
                const tableData = inventory.map(i => [i.id.toUpperCase(), i.name.toUpperCase(), i.stock, i.unit.toUpperCase(), i.stock <= i.min ? 'CRÍTICO' : 'OK']);
                doc.autoTable({ startY: 35, head: [['CÓDIGO', 'ARTÍCULO', 'STOCK', 'UNIDAD', 'ESTADO']], body: tableData, headStyles: { fillColor: [37, 99, 235] } });
                doc.save(`INVENTARIO_${new Date().toISOString().split('T')[0]}.pdf`);
            };

            const exportHistoryPDF = (filteredData = history, titleSuffix = "COMPLETA") => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18);
                doc.text(`AIRTEK ENERGÍA - BITÁCORA ${titleSuffix}`, 14, 20);
                const tableData = filteredData.map(h => [h.dateStr.toUpperCase(), h.item.toUpperCase(), (h.type === 'ENTRADA' || h.type === 'DEVOLUCION_HERRAMIENTA') ? `+${h.qty}` : `-${h.qty}`, String(h.type || 'SALIDA').toUpperCase(), String(h.tech || h.responsible || '---').toUpperCase(), String(h.monitor || '---').toUpperCase()]);
                doc.autoTable({ startY: 35, head: [['FECHA', 'ARTÍCULO', 'CANT', 'TIPO', 'RESPONSABLE', 'MONITOR']], body: tableData, headStyles: { fillColor: [37, 99, 235] } });
                doc.save(`BITACORA_${titleSuffix}.pdf`);
            };

            const filteredInventorySearch = useMemo(() => {
                if (!currentSearch) return [];
                const search = currentSearch.toLowerCase();
                return inventory.filter(i => i.name.toLowerCase().includes(search) || i.id.toLowerCase().includes(search)).slice(0, 5);
            }, [currentSearch, inventory]);

            const historyToShow = useMemo(() => {
                if (filterItemId === 'all') return history;
                return history.filter(h => h.itemId === filterItemId);
            }, [filterItemId, history]);

            const addItemToExitList = (item) => {
                if (selectedItems.find(si => si.id === item.id)) return;
                setSelectedItems([...selectedItems, { ...item, qty: 1 }]);
                setCurrentSearch('');
                setShowSearchList(false);
            };

            const removeSelected = (id) => setSelectedItems(selectedItems.filter(i => i.id !== id));
            const updateSelectedQty = (id, newQty) => setSelectedItems(selectedItems.map(i => i.id === id ? { ...i, qty: Math.max(1, Number(newQty)) } : i));

            const handleRestockSubmit = async (e) => {
                e.preventDefault();
                if (!restockItem || !restockQty) return;
                const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.FirebaseSDK;
                const qtyNum = Number(restockQty);
                const dateStr = new Date().toLocaleString().toUpperCase();
                try {
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory', restockItem.docId), { stock: restockItem.stock + qtyNum });
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history'), { type: 'ENTRADA', item: restockItem.name.toUpperCase(), itemId: restockItem.id.toUpperCase(), qty: qtyNum, responsible: restockResp.toUpperCase(), tech: 'ALMACÉN', monitor: restockResp.toUpperCase(), description: 'REPOSICIÓN', dateStr: dateStr, timestamp: serverTimestamp() });
                    setRestockItem(null); setRestockQty(''); setRestockResp(''); setActiveTab('history');
                } catch (err) { console.error(err); }
            };

            const handleBulkExit = async (e) => {
                e.preventDefault();
                if (selectedItems.length === 0 || !exitHeader.monitor) return;
                const { doc, writeBatch, collection, serverTimestamp } = window.FirebaseSDK;
                const batch = writeBatch(dbRef.current);
                const dateStr = new Date().toLocaleString().toUpperCase();
                try {
                    selectedItems.forEach(item => {
                        const invDocRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory', item.docId);
                        batch.update(invDocRef, { stock: item.stock - item.qty });
                        const histColRef = doc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'history'));
                        batch.set(histColRef, { type: 'SALIDA', tech: exitHeader.tech.toUpperCase(), monitor: exitHeader.monitor.toUpperCase(), description: exitHeader.description.toUpperCase(), item: item.name.toUpperCase(), itemId: item.id.toUpperCase(), qty: item.qty, dateStr: dateStr, timestamp: serverTimestamp() });
                    });
                    await batch.commit(); setSelectedItems([]); setExitHeader({ tech: '', monitor: '', description: '' }); setActiveTab('history');
                } catch (err) { console.error(err); }
            };

            const updateStock = async (docId, currentStock, mod) => {
                const { doc, updateDoc } = window.FirebaseSDK;
                try { await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory', docId), { stock: Math.max(0, currentStock + mod) }); } catch (err) { console.error(err); }
            };

            const handleAddItem = async (e) => {
                e.preventDefault();
                const { collection, addDoc, serverTimestamp } = window.FirebaseSDK;
                const dateStr = new Date().toLocaleString().toUpperCase();
                try {
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory'), { id: newItem.id.toUpperCase(), name: newItem.name.toUpperCase(), stock: Number(newItem.stock), min: Number(newItem.min), unit: newItem.unit.toUpperCase(), createdAt: serverTimestamp() });
                    setNewItem({ id: '', name: '', stock: '', min: 5, unit: 'PZA' }); setActiveTab('inventory');
                } catch (err) { console.error(err); }
            };

            const handleSaveEdit = async (e) => {
                e.preventDefault();
                const { doc, updateDoc } = window.FirebaseSDK;
                try { await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'inventory', editingItem.docId), { name: editingItem.name.toUpperCase(), id: editingItem.id.toUpperCase(), min: Number(editingItem.min), unit: editingItem.unit.toUpperCase() }); setEditingItem(null); } catch (err) { console.error(err); }
            };

            if (loading) return <div className="h-screen flex flex-col items-center justify-center bg-white"><div className="text-blue-600 animate-bounce mb-4"><EnergyLogo className="h-16 w-16" /></div><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">CONECTANDO...</p></div>;

            return (
                <div className="min-h-screen pb-20 no-print uppercase font-bold">
                    <header className="bg-white border-b border-slate-100 sticky top-0 z-50 px-6 py-4">
                        <div className="max-w-3xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="bg-blue-600 text-white p-2 rounded-xl shadow-lg"><EnergyLogo className="h-7 w-7" /></div>
                                <div>
                                    <div className="flex items-center gap-2"><span className="text-lg font-black text-slate-900 tracking-tighter uppercase">Airtek</span><span className="text-[10px] font-black bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded tracking-tighter uppercase">ENERGÍA</span></div>
                                    <div className="flex items-center gap-1.5 mt-0.5"><span className={`w-1.5 h-1.5 rounded-full ${isCloud ? 'bg-emerald-500 pulse-online' : 'bg-red-500'}`}></span><p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{isCloud ? 'ONLINE' : 'OFFLINE'}</p></div>
                                </div>
                            </div>
                            <button onClick={() => setIsAdminMode(!isAdminMode)} className={`text-[9px] px-2 py-1 rounded-full font-black tracking-wider transition-colors ${isAdminMode ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-400'}`}>{isAdminMode ? 'EDITOR ON' : 'EDITOR OFF'}</button>
                        </div>
                    </header>

                    <div className="max-w-3xl mx-auto p-4 space-y-6 mt-4">
                        <nav className="flex gap-1.5 bg-white p-1.5 rounded-3xl shadow-premium border border-slate-100 overflow-x-auto no-scrollbar">
                            {[
                                {id: 'inventory', label: 'INVENTARIO'}, {id: 'exit', label: 'DESPACHO'}, 
                                {id: 'tools', label: 'HERRAMIENTAS'}, {id: 'admin', label: 'MAESTRO'}, 
                                {id: 'history', label: 'BITÁCORA'}
                            ].map(t => (
                                <button key={t.id} onClick={() => {setActiveTab(t.id); setEditingItem(null); setRestockItem(null);}} className={`flex-1 min-w-[90px] py-3 rounded-2xl font-black text-[10px] uppercase tracking-wider transition-all ${activeTab === t.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-blue-50'}`}>{t.label}</button>
                            ))}
                        </nav>

                        <main className="tab-content">
                            {loaningTool && (
                                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                                    <form onSubmit={handleToolLoan} className="bg-white w-full max-w-md rounded-[2.5rem] p-8 space-y-4 shadow-2xl">
                                        <div className="text-center"><h3 className="text-sm font-black uppercase text-orange-500">PRÉSTAMO</h3><p className="text-[10px] font-black text-slate-400">{loaningTool.name}</p></div>
                                        <input required className="w-full p-4 bg-orange-50 rounded-2xl text-[14px] font-black border-2 border-orange-100 focus:border-orange-500 outline-none" value={loanData.tech} onChange={e=>setLoanData({...loanData, tech: e.target.value})} placeholder="TÉCNICO" />
                                        <select required className="w-full p-4 bg-orange-50 rounded-2xl text-[11px] font-black border-2 border-transparent outline-none uppercase" value={loanData.monitor} onChange={e=>setLoanData({...loanData, monitor: e.target.value})}><option value="">MONITOR...</option>{monitoresAlmacen.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                        <div className="flex gap-3 pt-4"><button type="button" onClick={()=>setLoaningTool(null)} className="flex-1 py-4 text-[10px] text-slate-400">CANCELAR</button><button type="submit" className="flex-2 bg-orange-500 text-white px-8 py-4 rounded-2xl font-black text-[10px] uppercase">CONFIRMAR</button></div>
                                    </form>
                                </div>
                            )}

                            {activeTab === 'inventory' && (
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-4"><h2 className="text-[10px] font-black text-slate-400 tracking-widest">EXISTENCIAS</h2><button onClick={exportInventoryPDF} className="bg-slate-900 text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest flex items-center gap-2">EXPORTAR PDF</button></div>
                                    {inventory.map(i => (
                                        <div key={i.docId} className="bg-white p-5 rounded-[2rem] flex flex-col sm:flex-row justify-between items-center shadow-sm border border-slate-100">
                                            <div className="flex items-center gap-4 w-full sm:w-auto"><button onClick={() => setEditingItem(i)} className="p-3 bg-slate-50 text-slate-400 rounded-xl"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><div className="flex flex-col"><span className="font-extrabold text-[13px] text-slate-800">{i.name}</span><span className="text-[9px] text-slate-400 font-mono font-bold uppercase">{i.id}</span></div></div>
                                            <div className="flex items-center gap-4 bg-slate-50 p-1.5 rounded-2xl"><button onClick={() => updateStock(i.docId, i.stock, -1)} className="w-9 h-9 flex items-center justify-center bg-white rounded-xl text-slate-400">-</button><div className="px-4 text-center min-w-[70px]"><div className={`font-black text-lg ${i.stock <= i.min ? 'text-red-500' : 'text-slate-900'}`}>{i.stock}</div><div className="text-[8px] text-slate-300 font-extrabold uppercase">{i.unit}</div></div><button onClick={() => updateStock(i.docId, i.stock, 1)} className="w-9 h-9 flex items-center justify-center bg-white rounded-xl text-slate-400">+</button><button onClick={() => setRestockItem(i)} className="px-4 py-2 bg-white rounded-xl font-black text-[10px] text-emerald-500 uppercase flex items-center gap-2">REPONER</button></div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {activeTab === 'exit' && (
                                <form onSubmit={handleBulkExit} className="bg-white p-8 rounded-[2.5rem] shadow-premium border border-slate-100 space-y-6">
                                    <div className="text-center"><h3 className="text-sm font-black text-slate-800">DESPACHO MATERIALES</h3></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input required className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black border-2 border-transparent outline-none uppercase" value={exitHeader.tech} onChange={e=>setExitHeader({...exitHeader, tech: e.target.value.toUpperCase()})} placeholder="TÉCNICO / PERSONA" /><select required className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black border-2 border-transparent outline-none uppercase appearance-none" value={exitHeader.monitor} onChange={e=>setExitHeader({...exitHeader, monitor: e.target.value})}><option value="">MONITOR ALMACÉN</option>{monitoresAlmacen.map(m => <option key={m} value={m}>{m.toUpperCase()}</option>)}</select></div>
                                    <div className="relative"><input className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none uppercase" value={currentSearch} onFocus={() => setShowSearchList(true)} onChange={e => {setCurrentSearch(e.target.value); setShowSearchList(true);}} placeholder="BUSCAR ARTÍCULO..." />{showSearchList && filteredInventorySearch.length > 0 && (<div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-2xl border border-slate-100 z-50">{filteredInventorySearch.map(i => (<div key={i.id} onClick={() => addItemToExitList(i)} className="p-4 hover:bg-blue-50 cursor-pointer flex justify-between items-center border-b last:border-0"><div><div className="text-[11px] font-black text-slate-800">{i.name}</div><div className="text-[9px] text-slate-400 font-mono font-black">{i.id}</div></div><div className="text-[10px] font-black text-blue-600">STOCK: {i.stock}</div></div>))}</div>)}</div>
                                    <div className="space-y-2">{selectedItems.map(item => (<div key={item.id} className="bg-slate-50 p-4 rounded-2xl flex items-center justify-between gap-4"><div className="flex-1"><div className="text-[11px] font-black text-slate-800 uppercase truncate">{item.name}</div><div className="text-[8px] font-black text-slate-400">DISPONIBLE: {item.stock}</div></div><div className="flex items-center gap-3"><input type="number" className="w-16 p-2 bg-white rounded-xl text-[11px] font-black text-center" value={item.qty} onChange={e => updateSelectedQty(item.id, e.target.value)} min="1" max={item.stock} /><button type="button" onClick={() => removeSelected(item.id)} className="p-2 text-slate-300">×</button></div></div>))}</div>
                                    <input required className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none uppercase" value={exitHeader.description} onChange={e=>setExitHeader({...exitHeader, description: e.target.value.toUpperCase()})} placeholder="NODO / OBSERVACIÓN" />
                                    <button disabled={selectedItems.length === 0} className="w-full bg-blue-600 disabled:bg-slate-200 text-white p-5 rounded-3xl font-black text-[11px] tracking-widest">PROCESAR SALIDA</button>
                                </form>
                            )}

                            {activeTab === 'tools' && (
                                <div className="space-y-6">
                                    <div className="flex flex-col gap-4 px-4">
                                        <h2 className="text-[10px] font-black text-slate-400 tracking-widest uppercase">CONTROL HERRAMIENTAS</h2>
                                        {/* BARRA BUSCADORA DE HERRAMIENTAS */}
                                        <div className="relative">
                                            <input 
                                                className="w-full p-4 bg-white rounded-2xl text-[11px] font-black shadow-sm border border-slate-100 outline-none uppercase pr-12" 
                                                value={toolSearch} 
                                                onChange={e => setToolSearch(e.target.value)} 
                                                placeholder="BUSCAR HERRAMIENTA O CÓDIGO..." 
                                            />
                                            <div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        {sortedAndFilteredTools.length > 0 ? (
                                            sortedAndFilteredTools.map(t => (
                                                <div key={t.docId} className={`bg-white p-5 rounded-[2rem] flex flex-col sm:flex-row justify-between items-center shadow-sm border ${t.status === 'PRESTADO' ? 'border-orange-200 bg-orange-50/30' : 'border-slate-100'}`}>
                                                    <div className="flex items-center gap-4"><div className={`p-3 rounded-xl ${t.status === 'PRESTADO' ? 'bg-orange-100 text-orange-500' : 'bg-emerald-100 text-emerald-500'}`}><EnergyLogo className="w-5 h-5" /></div><div className="flex flex-col"><span className="font-black text-[13px] text-slate-800">{t.name}</span><span className="text-[9px] text-slate-400 font-mono">{t.id}</span>{t.status === 'PRESTADO' && <span className="text-[9px] font-black text-orange-500 mt-1">ASIGNADO A: {t.assignedTo}</span>}</div></div>
                                                    <div className="flex items-center gap-2 mt-3 sm:mt-0">{t.status === 'DISPONIBLE' ? <button onClick={() => setLoaningTool(t)} className="px-6 py-3 bg-slate-900 text-white rounded-xl text-[10px] uppercase tracking-widest">PRESTAR</button> : <button onClick={() => handleToolReturn(t)} className="px-6 py-3 bg-white border-2 border-orange-500 text-orange-500 rounded-xl text-[10px] uppercase tracking-widest">DEVOLVER</button>}{isAdminMode && <button onClick={() => deleteTool(t.docId, t.name)} className="p-3 bg-red-50 text-red-400 rounded-xl">×</button>}</div>
                                                </div>
                                            ))
                                        ) : (
                                            <div className="text-center py-10 text-[10px] text-slate-400 font-black">NO SE ENCONTRARON HERRAMIENTAS</div>
                                        )}
                                    </div>

                                    {isAdminMode && (
                                        <form onSubmit={handleAddTool} className="bg-white p-8 rounded-[2.5rem] shadow-premium space-y-5"><div className="text-center font-black text-slate-800 text-xs">NUEVA HERRAMIENTA</div><input required placeholder="CÓDIGO" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none" value={newTool.id} onChange={e=>setNewTool({...newTool, id: e.target.value.toUpperCase()})} /><input required placeholder="NOMBRE" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none" value={newTool.name} onChange={e=>setNewTool({...newTool, name: e.target.value.toUpperCase()})} /><button className="w-full bg-slate-900 text-white p-5 rounded-3xl font-black uppercase text-[11px]">REGISTRAR</button></form>
                                    )}
                                </div>
                            )}

                            {activeTab === 'admin' && (
                                <form onSubmit={handleAddItem} className="bg-white p-8 rounded-[2.5rem] shadow-premium space-y-5">
                                    <div className="text-center font-black text-slate-800 text-xs">MAESTRO DE MATERIALES</div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input required placeholder="CÓDIGO" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none" value={newItem.id} onChange={e=>setNewItem({...newItem, id: e.target.value.toUpperCase()})} /><input required placeholder="DESCRIPCIÓN" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none" value={newItem.name} onChange={e=>setNewItem({...newItem, name: e.target.value.toUpperCase()})} /><input required type="number" placeholder="STOCK" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none" value={newItem.stock} onChange={e=>setNewItem({...newItem, stock: e.target.value})} /><input required placeholder="UNIDAD (PZA, MTS)" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none" value={newItem.unit} onChange={e=>setNewItem({...newItem, unit: e.target.value.toUpperCase()})} /></div>
                                    <button className="w-full bg-slate-900 text-white p-5 rounded-3xl font-black uppercase text-[11px]">GUARDAR</button>
                                </form>
                            )}

                            {activeTab === 'history' && (
                                <div className="space-y-4">
                                    <div className="bg-white p-6 rounded-[2.5rem] shadow-sm flex flex-col sm:flex-row gap-4">
                                        <select className="flex-1 p-3 bg-slate-50 rounded-xl text-[10px] font-black outline-none appearance-none" value={filterItemId} onChange={e => setFilterItemId(e.target.value)}><option value="all">TODOS LOS MOVIMIENTOS</option>{inventory.map(i => <option key={i.id} value={i.id}>{i.name.toUpperCase()}</option>)}</select>
                                        <button onClick={() => exportHistoryPDF(historyToShow, filterItemId === 'all' ? 'COMPLETA' : `DE ${filterItemId}`)} className="bg-slate-900 text-white px-4 py-3 rounded-xl text-[9px] font-black uppercase flex items-center gap-2 tracking-widest">PDF</button>
                                    </div>
                                    <div className="space-y-2.5">
                                        {historyToShow.map(h => {
                                            const isEntry = h.type === 'ENTRADA' || h.type === 'DEVOLUCION_HERRAMIENTA';
                                            const colorClass = isEntry ? 'emerald' : (h.type === 'PRESTAMO_HERRAMIENTA' ? 'orange' : 'red');
                                            return (
                                                <div key={h.id} className={`bg-white p-5 rounded-[2.2rem] flex flex-col sm:flex-row justify-between items-center shadow-sm border-l-4 border-l-${colorClass}-500 gap-3`}>
                                                    <div className="text-center sm:text-left"><div className="font-black text-[12px] text-slate-800">{h.item}</div><div className="text-[9px] font-black text-slate-500 mt-1 uppercase">{h.type?.replace('_',' ') || 'SALIDA'}: <span className="text-slate-900">{isEntry && h.type !== 'DEVOLUCION_HERRAMIENTA' ? h.responsible : h.tech}</span><span className="mx-2 text-slate-200">|</span>POR: <span className="text-blue-600">{h.monitor || '---'}</span></div></div>
                                                    <div className={`text-center sm:text-right shrink-0 px-4 py-2 rounded-2xl bg-${colorClass}-50`}>
                                                        <div className={`text-${colorClass}-600 font-black text-sm italic`}>{isEntry ? '+' : '-'}{h.qty}</div>
                                                        <div className="text-[8px] text-slate-400 font-black uppercase mt-0.5">{h.dateStr}</div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {restockItem && (
                                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                                    <form onSubmit={handleRestockSubmit} className="bg-white w-full max-w-md rounded-[2.5rem] p-8 space-y-4">
                                        <div className="text-center font-black text-emerald-600 text-xs">REPONER: {restockItem.name}</div>
                                        <input required type="number" min="1" className="w-full p-4 bg-emerald-50 rounded-2xl text-[14px] font-black text-center outline-none" value={restockQty} onChange={e=>setRestockQty(e.target.value)} placeholder="CANTIDAD" />
                                        <select required className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-black outline-none" value={restockResp} onChange={e=>setRestockResp(e.target.value)}><option value="">RESPONSABLE...</option>{monitoresAlmacen.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                        <div className="flex gap-3 pt-4"><button type="button" onClick={()=>setRestockItem(null)} className="flex-1 text-[10px]">CANCELAR</button><button type="submit" className="flex-2 bg-emerald-500 text-white px-8 py-4 rounded-2xl font-black text-[10px]">REPOSICIÓN</button></div>
                                    </form>
                                </div>
                            )}
                            {editingItem && (
                                <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                                    <form onSubmit={handleSaveEdit} className="bg-white w-full max-w-md rounded-[2.5rem] p-8 space-y-4 shadow-2xl">
                                        <div className="text-center font-black text-xs">EDITAR MATERIAL</div>
                                        <input required className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold outline-none uppercase" value={editingItem.name} onChange={e=>setEditingItem({...editingItem, name: e.target.value.toUpperCase()})} />
                                        <div className="grid grid-cols-2 gap-4"><input required className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold outline-none uppercase" value={editingItem.id} onChange={e=>setEditingItem({...editingItem, id: e.target.value.toUpperCase()})} /><input required type="number" className="w-full p-4 bg-slate-50 rounded-2xl text-[11px] font-bold outline-none" value={editingItem.min} onChange={e=>setEditingItem({...editingItem, min: e.target.value})} /></div>
                                        <div className="flex gap-3 pt-4"><button type="button" onClick={()=>setEditingItem(null)} className="flex-1 text-[10px]">CANCELAR</button><button type="submit" className="flex-2 bg-blue-600 text-white px-8 py-4 rounded-2xl font-black text-[10px]">ACTUALIZAR</button></div>
                                    </form>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



